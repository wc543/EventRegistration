<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/style.css">
        <script src="/comment.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
        
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/opencagedata/leaflet-opencage-geocoding@v2.0.0/dist/css/L.Control.OpenCageGeocoding.min.css" />
        <script src="https://cdn.jsdelivr.net/gh/opencagedata/leaflet-opencage-geocoding@v2.0.0/dist/js/L.Control.OpenCageGeocoding.min.js"></script>
        <script src="/map.js"></script>
        <script src="/payment.js"></script>
        
        <title>Events</title>
    </head>
    <body>
        <div class="container">
            <ul class="nav">
                <li><a href="../">Home</a></li>
                <li><a href="../login">Login</a></li>
            </ul>
            
            <h2>Event Registration</h2>
            
            <!-- Placeholder for displaying the event ID -->
            <p><strong id="eventIdDisplay"></strong></p>
            <p><strong id="eventPriceDisplay"></strong></p>
            <div id="buttonContainer"></div>
        </div>
        
        <div id="eventObject"></div>
        <div id="inviteFormContainer" style="display:none;">
            <h3>Invite Users to Private Event</h3>
            <form id="inviteUserForm">
                <label for="inviteUsername">Username:</label>
                <input type="text" id="inviteUsername" name="inviteUsername" required>
                <input type="hidden" id="eventId" name="eventId">
                <button type="submit">Invite</button>
            </form>
        </div>


        <script>
            async function loadEvent() {
        // Get the event ID from the URL
        let eventId = window.location.pathname.split('/').pop();

        // Display the event ID on the screen
        document.getElementById('eventIdDisplay').textContent = `Event ID: ${eventId}`;

        try {
            // Fetch event data from the server
            const response = await fetch(`/api/events/${eventId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            let eventElement = document.getElementById("eventObject");

            if (response.ok) {
                const event = await response.json();
                let videoUrl = '';

                try {
                    if(event.yt_link) {
                        console.log('YouTube link:', event.yt_link);
                        const url = new URL(event.yt_link);
                        console.log("URL: ", url);
                        const videoId = url.searchParams.get('v');
                        console.log("videoId: ", videoId);
                        if (videoId) {
                            videoUrl = await fetchVideo(videoId)
                        } else {
                            console.error('YouTube URL missing video ID:', event.yt_link);
                        }
                    } else {
                        console.error('YouTube link undefined', event.yt_link);
                    }
                } catch (error) {
                    console.error('Invalid YouTube URL:', event.yt_link, error);
                    videoUrl = '';
                }

                async function fetchVideo(videoId) {
                    console.log("videoIdINSIDE: ", videoId);
                    try {
                        const response = await fetch(`/api/video/${videoId}`);
                        if (!response.ok) {
                            throw new Error('Failed to fetch video');
                        }
                        const video = await response.json();
                        console.log("video :", video);
                        return video.embedUrl;
                    } catch (error) {
                        console.error('Error:', error);
                        return '';
                    }
                }

                geocode = await fetchGeocode(event.address);
                const mapId = `map-${event.id}`;
                console.log(event.price);

                eventElement.innerHTML = `
                    <div class="event-container">
                        <div class="event-details">
                            <h3>${event.event_name}</h3>
                            <p>${event.description}</p>
                            <p><strong>Date:</strong> ${new Date(event.event_date).toLocaleDateString()}</p>
                            <p><strong>Location:</strong> ${event.address}</p>
                            <div id="${mapId}" class="map-container"></div>
                            ${event.is_private ? `<button class="inviteBtn" data-event-id="${event.id}">Invite Users</button>` : ''}
                            <p><strong>YouTube Link:</strong> <a href="${event.yt_link}" target="_blank">${event.yt_link}</a></p>

                            ${videoUrl ? `
                                <p><strong>YouTube Video:</strong></p>
                                <iframe width="720" height="400" src="${videoUrl}" frameborder="0" allowfullscreen></iframe>
                                ` : `<p><strong>YouTube Video:</strong></p>`}
                        </div>
                        <div class="comments-section">
                            <h4>Comments</h4>
                            <form id="comment-form-${event.id}" data-event-id="${event.id}" class="comment-form">
                                <input type="text" name="comment" placeholder="Add comment" required>
                                <button type="submit">Post</button>
                            </form>
                            <div class="comments-list-${event.id}"></div>
                        </div>
                    </div>
                `;
                fetchComments(eventId);
                if(geocode) {
                    console.log(mapId, geocode.lat, geocode.lng, event.address, event.event_name);
                    createMap(mapId, geocode.lat, geocode.lng, event.address, event.event_name);
                }
                const form = document.getElementById(`comment-form-${event.id}`);

                if (form) {
                    form.addEventListener('submit', async (event) => {
                        event.preventDefault(); // Prevent the form from submitting normally
                        const input = form.querySelector('input[name="comment"]');
                        const commentText = input.value;

                        await postComment(eventId, commentText);
                        input.value = '';
                    });
                } else {
                    console.error(`Form with ID comment-form-${event.id} not found`);
                }
                if (event.is_private) {
                    const inviteBtn = eventElement.querySelector('.inviteBtn');
                    inviteBtn.addEventListener('click', function() {
                        const eventId = this.getAttribute('data-event-id');
                        document.getElementById('eventId').value = eventId; // Set the event ID in the invite form
                        document.getElementById('inviteFormContainer').style.display = 'block'; // Show the invite form
                    });
                }

                if(event.price) {
                    console.log("price:", event.price);
                    console.log("event name:", event.event_name);

                    document.getElementById('eventPriceDisplay').textContent = `Price: $${event.price}`;
                    const buttonContainer = document.getElementById('buttonContainer');
                    const purchase = document.createElement("button");
                    purchase.textContent = "Book Ticket";
                    buttonContainer.appendChild(purchase);

                    purchase.addEventListener('click', async function() {
                        await fetchPayment(event.price, event.event_name);
                    });
                }

            } else {
                console.error('Failed to fetch event');
                alert('Failed to load event');
            }
        } catch (error) {
            console.error('Error fetching event:', error);
        }

        document.getElementById('inviteUserForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const username = document.getElementById('inviteUsername').value;
        const eventId = document.getElementById('eventId').value;

        try {
            const response = await fetch('/api/events/inviteUser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, eventId })
            });

            if (response.ok) {
                const result = await response.json();
                alert(`User invited successfully! Invitation link: ${result.invitationLink}`);
            } else {
                const errorResult = await response.json();
                alert(`Failed to invite user: ${errorResult.error}`);
            }
        } catch (error) {
            console.error('Error inviting user:', error);
        }


        
    });


    async function fetchGeocode(address) {
            try {
                const encodeAddress = encodeURIComponent(address);
                const response = await fetch(`/api/geocode?address=${encodeAddress}`);
                if(!response.ok) {
                    throw new Error('Failed to fetch geocode');
                }
                const geocode = await response.json();
                console.log(geocode);
                return geocode;
            } catch (error) {
                console.error('Error:', error);
            }
        }
    }

    // Handle tab switching
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });


    // Run the async function
    loadEvent();
        </script>
    </body>
</html>
